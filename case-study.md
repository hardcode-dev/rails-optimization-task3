# Case-study оптимизации

## Актуальная проблема
1. Импорт данных из json занимает большое время(на 1млн записей импорт длился 7 минут)
2. Загрузка страници `автобусы/` занемает большое время, если данных много, на ней явно есть лишнии запросы(на начальном этпе ~55) и у сущностей ро которым идет поиск нет индексоа

Я решил исправить эту проблему, оптимизировав эту программу.


## Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я придумал использовать такую метрику: 
1. программа затрачивает на обработку больших файлов не больше 1 минуты
2. При открытии страници проискодит не более 4 запросов
Перед оптимизацией программа затрачивает на обработку файла в 50000 строк 335 MB

## Гарантия корректности работы оптимизированной программы
1. На писан юнит тест гарантирующий корректную работу рейк таски `UtilsTest`
2. Написан системный тест который гарантирует сохранность структуры страници `TripsTest`
 

## Вникаем в детали системы, чтобы найти главные точки роста
Для того, чтобы найти "точки роста" для оптимизации я воспользовался:

- pghero
- rack-mini-profiler
- benchmark
- byebug


Вот какие проблемы удалось найти и решить

### Оптимизация загрузки данных
С помощью `benchmark` замерял время работы

1. На первом этапе было внесенно изменение позволяющее последовательно читать json файл а не весь целиком(json-stream)
2. Затем что бы поиск сущностей для создагия Trip происходил быстрее добавил индексы  автобусов и сервисов
3. Так как импорт данных все равно не укладывался в бюджет, воспользовался библиотекой `ActiveRecord::Import` и стал агрегировать города, автобусы и сервисы, и затем их импортить одной транзакцией(данных сущностей на 1м записей находится в памяти не больше 100 обектов)
4. Последним этапом перевел таску на стриминг данных в БД

### Оптимизация страници
Вявил с помощю гема `bullet` что на странице есть N+1 запрос
rack-mini-profiler - показал что на странице есть много однотипных запросов(обращения к сервисам и автобусам)
1. Зделал предзагрузку связанных даннях `.eager_load(bus: :services)`
2. Добавил индекс для города на поле `name` проверил с помощью pghero что поиск города происходит по городу(визуализация explain)
3. Добавил пагинацию - это позволяло не загружать на страницу сразу все сущности



## Результаты
1. В результате загрузка файла в 1m - длится 12 сек
2. При загрузке страници происходит всего 3 запроса
3. Загрузка занимает ~50 mls

## Защита от регрессии производительности
1. Перформ тест проверющий что таска выполняется не более 60 сек
2. Тест контроллера - если будет n + 1 запрос тест упадет с ошибкой