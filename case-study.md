# Case-study оптимизации

## Актуальные проблемы
В проекте возникли несколько серьёзных проблем.
- Долгий импорт данных, при объеме данных более 30 мегабайт
- При большом объеме данных начинает тормозить страница расписаний.

### Импорт данных
В приложении есть rake таска, которая удаляет все ранее загруженные данные, и добавляет новые из предоставленного файла.
```
bin/rake reload_json[file]
```
Она успешно работала на файлах размером пару мегабайт, но для большого файла она работала слишком долго.
Я решил исправить эту проблему, оптимизировав эту программу.

#### Формирование метрики
Для того, чтобы понимать, дают ли мои изменения положительный эффект на быстродействие программы я добавил вывод времени выполнения программы (определяю временную метку в начале выполнения и в конце, и смотрю разницу).
При первом запуске программы с medium.json файлом она отработала за ~ 1 минуту.

#### Гарантия корректности работы оптимизированной программы
Для гарантии был добавлен тест при который в фидбек-лупе позволяет не допустить изменения логики программы при оптимизации.
```
  bundle exec rspec spec/tasks/utils_spec.rb
```

#### Профилирование
Чтобы понять какие проблемы с программой, я решил использовать логи, которые записываются в `log/development.log`.

#### Поиск проблем
После первого запуска программы, логи показали очень большое количество SELECT запросов для таблиц cities, services и buses, это связано было с тем, что перед созданием записи мы проверяли наличие существующей записи.
Было решено добавить HASH переменные, в которые можно было бы по ключу добавлять записи, чтобы при необходимости получать нужную запись по ключу.
После этого программа для medium.json файла стала отрабатывать за ~ 12 секунд.

С large.json программа отрабатывала за ~ 1 минуту.
Логи показали на большое количество INSERT trips, потому что записи создавались по отдельности. Было решено использовать метод upsert_all, который добавляет записи одним запросом.
После этого программа для large.json файла стала отрабатывать за ~ 7 секунд.

Логи показали что осталисось много INSERT INTO "buses_services", но их пока не понятно как загружать
```
  Bulk insert or upsert is currently not supported for has_many through association
```

#### Результаты
В результате проделанной оптимизации наконец удалось обработать файл с данными.
Удалось улучшить метрику с более 1 минуты, до примерно 7 секунд и уложиться в заданный бюджет.

#### Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы был добавлен тест. 
```
  bundle exec rspec spec/tasks/utils_spec.rb
```

### Отображение расписаний
... в процессе