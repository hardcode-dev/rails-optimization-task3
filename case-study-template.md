# Case-study оптимизации

## Актуальная проблема
1. Долгий импорт данных в БД
2. Долгое отображение расписаний

## Формирование метрики
Mетрика: *время импорта данных в БД в секундах, расчитываемое на файле `large.json`.*
Бюджет: 60 секунд.

## Гарантия корректности работы оптимизированной программы
Тест соответствия скорости импорта бюджету
Тест корректности импорта (`fixtures/example.json`)

## Вникаем в детали системы, чтобы найти главные точки роста
Стартовый benchmark: 
# small.json - 4.13s
# medium.json - 57.1s

### Неоптимальная запись в БД
Использование гема activerecord-import:
small.json - 2.26s
medium.json - 18.78s

Забавно, что использование гема oj для загрузки json дало обратный результат:
small.json - 2.31s
medium.json - 19.25s
large.json - 193.09s
В итоге остановился на FastJsonParse, добавили batch_size
small.json - 2.11s
medium.json - 18.28s
large.json - 182.09s

Осталось закэшировать bus_services, воспользуемся отсутствием false: id в schema
small.json - 0.8s
medium.json - 1.92s
large.json - 8.34s
Разница драматическая, на этом эту часть заканчиваем

Поставил pg_hero - eму все нравится, полезной инфы - нет
Rails panel - не заработал
Bullet разумеется помог, но он меня достал уже на рабочем Проекте), здесь все гораздо хуже, ибо он лезет ото всюду - из поискового окна, прямо со страницы... там конечно все настраивается, но он все равно мне не нравится
rack-mini-profiler - великолепен штука: ненавязчивый и удобный, всегда им пользуюсь

Render time, start:
5746.0 ms 1886 sql - RMP
Completed 200 OK in 5737ms (Views: 4483.1ms | ActiveRecord: 1247.9ms)

### Рендеринг страницы
- Добавляем индексы поисковым полям: City#name, Trip#from/to (составной)
- size вместо count для trips
- в trip.html прелоадим bus для trip и services для bus
- #any? вместо #presence?
Completed 200 OK in 2865ms (Views: 2834.6ms | ActiveRecord: 24.0ms)
2874.2 ms 7 sql - запросы выглядят хорошо, но выигрыш по времени небольшой

Bullet молчит - но по RMP видно что многовато времени в сумме на паршиалы, объединим их в один
Completed 200 OK in 223ms (Views: 194.9ms | ActiveRecord: 22.5ms)
231.5 ms 7 sql - разница драматическая, не все паршиалы одинаково полезны). Заканчиваем.

Render time, finish
Completed 200 OK in 223ms (Views: 194.9ms | ActiveRecord: 22.5ms)
231.5 ms 7 sql

## Результаты
- импорт файла `fixtures/large.json`: 8-9 s
- время рендеринга страницы `автобусы/Самара/Москва` на базе файла large.json: 200-300 ms

*Какими ещё результами можете поделиться*
- Bullet ожидаемо утомителен
- RMP ожидаемо хорош
- паршиалы - красиво и архитектурно, но ни дороговато ли они стоят подчас? Это главный вывод для меня сегодня.
P.S. На работе пользуюсь AppSignal вместо Rollbar - пока доволен

## Защита от регрессии производительности
Для защиты от потери достигнутого прогресса при дальнейших изменениях программы написал тесты:
Тест соответствия скорости импорта бюджету
Тест корректности импорта (`fixtures/example.json`)
